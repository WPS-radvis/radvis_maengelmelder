name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4


      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'


      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install


      - name: Start Backend
        run:
          cd backend && ./mvnw spring-boot:run -Dspring-boot.run.profiles=test > backend_logs.txt 2>&1 &
          npx wait-on http://localhost:8080/h2-console --timeout 60000

      - name: Start Frontend
        run: |
          npm run start:frontend & 
          npx wait-on http://localhost:4200 --timeout 120000


      - name: Run E2E Tests
        run: npm run e2e:ci

      - name: Upload E2E Artifacts on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-reports
          path: |
          frontend/test-results/
          frontend/playwright-report/
          retention-days: 7